<script>
document.addEventListener("DOMContentLoaded", function() {
    console.log("âœ¨ Smart Auto Sidebar loaded!");

    // Ambil title dari halaman
     // Ambil title dari halaman (hasil render YAML)
    var pageTitle = document.querySelector("h1.title")?.innerText || "Judul Tidak Ada";

    // Jika ingin subtitle:
    var pageSubtitle = document.querySelector("h4.subtitle")?.innerText || "";

    // Ambil author dari halaman (hasil render YAML)
    var pageAuthor = document.querySelector("p.author")?.innerText ||
                     document.querySelector(".author")?.innerText ||
                     "Author Tidak Ada";

    // Set ke sidebar
    document.getElementById("sidebarTitle").innerText = pageTitle;

    // Set ke topbar
    document.getElementById("pageTitle").innerText = pageTitle;

    // Set author ke sidebar
    const authorDiv = document.querySelector('.sidebar-author');
    if (authorDiv && pageAuthor !== "Author Tidak Ada") {   
        authorDiv.innerHTML = pageAuthor.replace(/\n/g, '<br>');
    }

    // Set initial collapsed state
    document.body.classList.add('sidebar-collapsed');

    // Build sidebar dengan smart detection
    buildSmartSidebar();

    // Initialize fitur dasar
    initSidebarToggle();
    initThemeToggle();
    initSmoothScroll();
    initSmartAutoSidebar();
    initBackToTop();

    console.log("ðŸŽ‰ Smart sidebar initialized!");
});

function buildSmartSidebar() {
    const sidebarMenu = document.querySelector(".sidebar-menu");
    if (!sidebarMenu) return;

    sidebarMenu.innerHTML = "";

    const main = document.querySelector(".main-container") || 
                 document.querySelector(".container-fluid") || 
                 document.body;

    // DEBUG: Lihat semua heading dan parent-nya
    const allHeadings = Array.from(main.querySelectorAll("h1, h2, h3"));
    console.log("=== DEBUG HEADING STRUCTURE ===");
    allHeadings.forEach((h, i) => {
        console.log(`Heading ${i}:`, {
            text: h.textContent.substring(0, 50),
            tag: h.tagName,
            id: h.id,
            class: h.className,
            parent: h.parentElement?.className || h.parentElement?.tagName,
            parentTag: h.parentElement?.tagName,
            parentId: h.parentElement?.id,
            html: h.outerHTML.substring(0, 100)
        });
    });

    // FILTER SEMENTARA: Ambil semua dulu, nanti kita filter
    const headings = allHeadings.filter(h => 
        !h.classList.contains('title') && 
        h.textContent.trim().length > 0
    );

    let currentH1 = null;
    let currentH2 = null;

    headings.forEach((heading, index) => {
        const level = parseInt(heading.tagName.substring(1));
        
        if (!heading.id) {
            heading.id = `section-${index}-${Date.now()}`;
        }

        const li = document.createElement("li");
        li.className = `sidebar-lvl-${level}`;
        li.setAttribute('data-level', level);
        li.setAttribute('data-heading-id', heading.id);

        const a = document.createElement("a");
        a.href = "#" + heading.id;
        a.textContent = heading.textContent;
        a.setAttribute('data-section', heading.id);
        
        a.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
        
        li.appendChild(a);

        // Atur hierarchy berdasarkan level
        if (level === 1) {
            sidebarMenu.appendChild(li);
            currentH1 = li;
            currentH2 = null;
        } else if (level === 2 && currentH1) {
            let h2Container = currentH1.querySelector('.h2-container');
            if (!h2Container) {
                h2Container = document.createElement('ul');
                h2Container.className = 'h2-container collapsed';
                currentH1.appendChild(h2Container);
            }
            h2Container.appendChild(li);
            currentH2 = li;
        } else if (level === 3 && currentH2) {
            let h3Container = currentH2.querySelector('.h3-container');
            if (!h3Container) {
                h3Container = document.createElement('ul');
                h3Container.className = 'h3-container collapsed';
                currentH2.appendChild(h3Container);
            }
            h3Container.appendChild(li);
        }
    });

    console.log("Sidebar built with:", headings.length, "headings");
}


// FUNCTION BARU: Smart detection untuk heading Markdown
function isMarkdownGeneratedHeading(headingElement) {
    const html = headingElement.outerHTML;
    const text = headingElement.textContent.trim();
    
    // 1. Deteksi berdasarkan HTML structure
    // Heading Markdown biasanya punya structure yang clean
    const isCleanHTML = !html.includes('</h1>') && !html.includes('</h2>') && !html.includes('</h3>');
    
    // 2. Deteksi berdasarkan parent context
    // Heading Markdown biasanya langsung di dalam container content
    const parent = headingElement.parentElement;
    const isInContentContainer = parent?.classList?.contains('main-container') || 
                                parent?.classList?.contains('container-fluid') ||
                                parent?.tagName === 'DIV';
    
    // 3. Deteksi berdasarkan sibling elements
    // Heading Markdown biasanya diikuti oleh paragraph atau content lain
    const nextSibling = headingElement.nextElementSibling;
    const hasContentSiblings = nextSibling && 
                              (nextSibling.tagName === 'P' || 
                               nextSibling.tagName === 'DIV' || 
                               nextSibling.tagName === 'PRE');
    
    // 4. Deteksi berdasarkan text pattern
    // Heading HTML manual sering pendek atau spesifik
    const isLongEnough = text.length > 5;
    const hasNormalText = !text.match(/^[0-9\.\s]+$/) && // bukan cuma angka/titik
                         !text.match(/^[A-Z\s]+$/) &&    // bukan cuma uppercase
                         text.indexOf('<') === -1;       // tidak mengandung HTML tags
    
    // 5. Deteksi berdasarkan R Markdown specific attributes
    const hasRMarks = headingElement.classList.contains('section') ||
                     headingElement.hasAttribute('data-number') ||
                     headingElement.previousElementSibling?.tagName === 'H1' ||
                     headingElement.previousElementSibling?.tagName === 'H2';

    // Kombinasi logic: Jika memenuhi kriteria Markdown
    const markdownScore = 
        (isCleanHTML ? 1 : 0) +
        (isInContentContainer ? 1 : 0) + 
        (hasContentSiblings ? 1 : 0) +
        (isLongEnough ? 1 : 0) +
        (hasNormalText ? 1 : 0) +
        (hasRMarks ? 2 : 0); // Extra points untuk R Markdown attributes

    // Threshold: score >= 3 dianggap sebagai Markdown heading
    return markdownScore >= 3;
}

function initSmartAutoSidebar() {
    const main = document.querySelector(".main-container") || 
                 document.querySelector(".container-fluid") || 
                 document.body;
    
    // Gunakan filter yang sama untuk observer
    const sections = Array.from(main.querySelectorAll("h1, h2, h3")).filter(h => {
        const isTitle = h.classList.contains('title');
        const isEmpty = h.textContent.trim().length === 0;
        const isMarkdownHeading = isMarkdownGeneratedHeading(h);
        
        return !isTitle && !isEmpty && isMarkdownHeading;
    });

    console.log("Smart observer watching:", sections.length, "Markdown sections");

    let ticking = false;

    function updateSidebar() {
        const scrollY = window.scrollY;
        let currentActive = null;
        let currentDistance = Infinity;

        sections.forEach(section => {
            const rect = section.getBoundingClientRect();
            const distance = Math.abs(rect.top);
            
            if (distance < currentDistance && rect.top < 100) {
                currentDistance = distance;
                currentActive = section;
            }
        });

        if (currentActive) {
            updateSidebarState(currentActive);
        }
        
        ticking = false;
    }

    function updateSidebarState(activeSection) {
        const headingId = activeSection.id;
        
        // Remove active class dari semua
        document.querySelectorAll('.sidebar-menu li').forEach(item => {
            item.classList.remove('active');
        });

        // Add active ke current item
        const sidebarItem = document.querySelector(`[data-heading-id="${headingId}"]`);
        if (sidebarItem) {
            sidebarItem.classList.add('active');
            
            // Auto expand parents
            expandAllParents(sidebarItem);
            
            // Collapse unrelated sections
            collapseUnrelatedSections(sidebarItem);
        }
    }

    function expandAllParents(item) {
        let current = item.parentElement;
        
        while (current && current !== document.querySelector('.sidebar-menu')) {
            if (current.classList.contains('h2-container') || 
                current.classList.contains('h3-container')) {
                current.classList.remove('collapsed');
            }
            current = current.parentElement;
        }
    }

    function collapseUnrelatedSections(activeItem) {
        document.querySelectorAll('.h2-container').forEach(container => {
            const isActiveContainer = container.contains(activeItem) || 
                                    container.parentElement === activeItem;
            if (!isActiveContainer) {
                container.classList.add('collapsed');
            }
        });

        document.querySelectorAll('.h3-container').forEach(container => {
            const isActiveContainer = container.contains(activeItem);
            if (!isActiveContainer) {
                container.classList.add('collapsed');
            }
        });
    }

    window.addEventListener('scroll', function() {
        if (!ticking) {
            requestAnimationFrame(updateSidebar);
            ticking = true;
        }
    });

    setTimeout(updateSidebar, 100);
}

// ... (FUNGSI LAINNYA TETAP SAMA)
function initSidebarToggle() {
    const toggleSidebarBtn = document.getElementById('toggleSidebar');
    const toggleContainer = document.getElementById('sidebarToggleContainer');

    function isMobile() {
        return window.innerWidth <= 768;
    }

    function toggleSidebar() {
        if (isMobile()) {
            document.body.classList.toggle('sidebar-mobile-open');
        } else {
            document.body.classList.toggle('sidebar-collapsed');
            updateTogglePosition();
        }
    }

    function updateTogglePosition() {
        const isCollapsed = document.body.classList.contains('sidebar-collapsed');
        if (toggleContainer) {
            if (isCollapsed) {
                toggleContainer.style.left = '10px';
            } else {
                toggleContainer.style.left = '260px';
            }
        }
    }

    // Handle window resize to switch behavior
    function handleResize() {
        if (isMobile()) {
            // On mobile, ensure sidebar is hidden by default and toggle button is accessible
            document.body.classList.remove('sidebar-collapsed');
            if (toggleContainer) {
                toggleContainer.style.left = '10px';
            }
        } else {
            // On desktop, use collapsed state
            updateTogglePosition();
        }
    }

    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', toggleSidebar);
    }

    // Initial setup
    handleResize();

    // Listen for window resize
    window.addEventListener('resize', handleResize);

    // Animation for menu items
    const menuItems = document.querySelectorAll(".sidebar-menu li");
    let d = 0;
    menuItems.forEach(item => {
        setTimeout(() => {
            item.classList.add("show");
        }, 90 * d);
        d++;
    });
}

function initThemeToggle() {
    const toggleThemeBtn = document.getElementById('toggleTheme');
    if (toggleThemeBtn) {
        const savedTheme = localStorage.getItem('theme');
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        
        if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
            document.body.classList.add('dark-theme');
            toggleThemeBtn.textContent = 'â˜€ï¸';
        } else {
            document.body.classList.remove('dark-theme');
            toggleThemeBtn.textContent = 'ðŸŒ“';
        }

        toggleThemeBtn.addEventListener('click', function() {
            const isDark = document.body.classList.contains('dark-theme');
            
            if (isDark) {
                document.body.classList.remove('dark-theme');
                localStorage.setItem('theme', 'light');
                this.textContent = 'ðŸŒ“';
            } else {
                document.body.classList.add('dark-theme');
                localStorage.setItem('theme', 'dark');
                this.textContent = 'â˜€ï¸';
            }
        });
    }
}

function initSmoothScroll() {
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
}

function initBackToTop() {
    const backToTopBtn = document.createElement('button');
    backToTopBtn.id = 'backToTop';
    backToTopBtn.className = 'back-to-top';
    backToTopBtn.textContent = 'â†‘';
    backToTopBtn.title = 'Back to Top';
    document.body.appendChild(backToTopBtn);

    backToTopBtn.addEventListener('click', function() {
        window.scrollTo({
            top: 0,
            behavior: 'smooth'
        });
    });

    window.addEventListener('scroll', function() {
        if (window.pageYOffset > 300) {
            backToTopBtn.classList.add('show');
        } else {
            backToTopBtn.classList.remove('show');
        }
    });
}
</script>


